---
title: Webpack 5 å‰ç«¯æ„å»ºå·¥å…·å‡çº§
date: 2021-06-13 21:30:28
categories:
  - Frontend Development
  - Build Tools
tags:
  - Webpack
---

### æ ¸å¿ƒæ”¹è¿›

- **æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰**ï¼šå¾®å‰ç«¯è§£å†³æ–¹æ¡ˆ
- **æŒä¹…åŒ–ç¼“å­˜**ï¼šæ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦
- **Tree Shaking ä¼˜åŒ–**ï¼šæ›´å½»åº•çš„æ— ç”¨ä»£ç æ¶ˆé™¤
- **Bundle åˆ†æ**ï¼šæ›´å¥½çš„åŒ…å¤§å°ä¼˜åŒ–
- **Node.js Polyfill ç§»é™¤**ï¼šå‡å°‘ bundle ä½“ç§¯
- **æ›´å¥½çš„é•¿æœŸç¼“å­˜**ï¼šæ”¹è¿›çš„ç¡®å®šæ€§ chunk å’Œ module ID

## ä¸»è¦æ–°ç‰¹æ€§è¯¦è§£

### 1. æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰

è¿™æ˜¯ Webpack 5 æœ€å¼•äººæ³¨ç›®çš„æ–°ç‰¹æ€§ï¼Œå®ƒå…è®¸å¤šä¸ªç‹¬ç«‹çš„æ„å»ºå¯ä»¥å…±äº«ä»£ç ï¼Œå®ç°çœŸæ­£çš„å¾®å‰ç«¯æ¶æ„ã€‚

#### Webpack 4 vs Webpack 5 å¯¹æ¯”

**Webpack 4 çš„ç—›ç‚¹ï¼š**

```javascript
// Webpack 4 æ— æ³•åœ¨è¿è¡Œæ—¶å…±äº«æ¨¡å—ï¼Œåªèƒ½é€šè¿‡ä¼ ç»Ÿæ–¹å¼ä½¿ç”¨ç¬¬ä¸‰æ–¹å…±äº«ç»„ä»¶

// æ–¹æ³• 1ï¼šé€šè¿‡ npm åŒ…å…±äº«ç»„ä»¶
// æ‰€æœ‰å­é¡¹ç›®éƒ½éœ€è¦å®‰è£… shared-ui-libï¼Œé‡å¤æ‰“åŒ…ã€ç‰ˆæœ¬ç®¡ç†ç¹ç
import { Button } from "shared-ui-lib";

function App() {
  return <Button text="ç‚¹å‡»æˆ‘" />;
}

// æ–¹æ³• 2ï¼šé€šè¿‡ <script> æ ‡ç­¾å¼•å…¥å…¨å±€å˜é‡ï¼ˆä¾‹å¦‚ React æˆ–ç»„ä»¶åº“ï¼‰
<script src="https://cdn.example.com/shared-ui-lib.min.js"></script>;

const Button = window.SharedUiLib.Button;

function App() {
  return React.createElement(Button, { text: "ç‚¹å‡»æˆ‘" });
}

// ğŸ“› é—®é¢˜ï¼š
// - æ²¡æœ‰æ¨¡å—éš”ç¦»ã€ç‰ˆæœ¬å†²çªé¢‘ç¹
// - æ— æ³•å®ç°çœŸæ­£çš„åŠ¨æ€åŠ è½½å’Œè·¨é¡¹ç›®æ¨¡å—å¤ç”¨
// - æ¯ä¸ªå­é¡¹ç›®ä»éœ€æ‰‹åŠ¨é›†æˆã€ç»´æŠ¤å’Œæ‰“åŒ…å…±äº«æ¨¡å—
```

**Webpack 5 çš„è§£å†³æ–¹æ¡ˆï¼š**

```javascript
// webpack.config.js - ä¸»åº”ç”¨
const ModuleFederationPlugin = require("@module-federation/webpack");

module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: "shell", // ä¸»åº”ç”¨å
      remotes: {
        mfe1: "mfe1@http://localhost:3001/remoteEntry.js", // å¼•å…¥å­åº”ç”¨ mfe1
        mfe2: "mfe2@http://localhost:3002/remoteEntry.js", // å¼•å…¥å­åº”ç”¨ mfe2
      },
    }),
  ],
};

// å­åº”ç”¨é…ç½®
module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: "mfe1", // å­åº”ç”¨å
      filename: "remoteEntry.js", // è¿œç¨‹å…¥å£æ–‡ä»¶
      exposes: {
        "./Button": "./src/components/Button", // æš´éœ²ç»„ä»¶
        "./Header": "./src/components/Header",
      },
    }),
  ],
};
```

**ä½¿ç”¨æ¨¡å—è”é‚¦ï¼š**

```javascript
// åŠ¨æ€å¯¼å…¥è¿œç¨‹æ¨¡å—
const RemoteButton = React.lazy(() => import("mfe1/Button"));

function App() {
  return (
    <div>
      <Suspense fallback={<div>Loading...</div>}>
        <RemoteButton />
      </Suspense>
    </div>
  );
}
```

| åŠŸèƒ½/å¯¹æ¯”ç‚¹       | Webpack 4                | Webpack 5 + Module Federation     |
| ----------------- | ------------------------ | --------------------------------- |
| æ¨¡å—å…±äº«          | é™æ€å…±äº«ï¼ˆnpm/CDNï¼‰      | åŠ¨æ€å…±äº«ï¼ˆè¿è¡Œæ—¶åŠ è½½ï¼‰            |
| è·¨åº”ç”¨ç»„ä»¶å¤ç”¨    | ç¹çï¼Œéœ€æ‰“åŒ…è¿›å„åº”ç”¨     | æ”¯æŒæŒ‰éœ€è¿œç¨‹åŠ è½½ï¼Œä¸é‡å¤æ‰“åŒ…      |
| ä¾èµ–éš”ç¦»/å†²çªå¤„ç† | éœ€æ‰‹åŠ¨å¤„ç†ï¼Œå®¹æ˜“ç‰ˆæœ¬å†²çª | æ”¯æŒ `singleton` è‡ªåŠ¨å…±äº«ä¾èµ–ç‰ˆæœ¬ |
| å¾®å‰ç«¯æ¶æ„æ”¯æŒ    | ä¸æ”¯æŒ                   | âœ… åŸç”Ÿæ”¯æŒ                       |

### 2. æŒä¹…åŒ–ç¼“å­˜

Webpack 5 å¼•å…¥äº†å¼ºå¤§çš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œå¤§å¹…æå‡äºŒæ¬¡æ„å»ºé€Ÿåº¦ã€‚

#### å¯¹æ¯”åˆ†æ

**Webpack 4ï¼š**

```javascript
// åªæœ‰å†…å­˜ç¼“å­˜ï¼Œæ¯æ¬¡é‡å¯éƒ½éœ€è¦é‡æ–°æ„å»º
module.exports = {
  cache: true, // åªèƒ½ç¼“å­˜åˆ°å†…å­˜
};
```

**Webpack 5ï¼š**

```javascript
module.exports = {
  cache: {
    type: "filesystem", // æ–‡ä»¶ç³»ç»Ÿç¼“å­˜
    buildDependencies: {
      config: [__filename], // é…ç½®æ–‡ä»¶å˜åŒ–æ—¶ä½¿ç¼“å­˜å¤±æ•ˆ
    },
    cacheDirectory: path.resolve(__dirname, ".webpack-cache"),
  },
};
```

**æ€§èƒ½æå‡å¯¹æ¯”ï¼š**

- é¦–æ¬¡æ„å»ºï¼šWebpack 5 ç•¥æ…¢ï¼ˆéœ€è¦å†™å…¥ç¼“å­˜ï¼‰
- äºŒæ¬¡æ„å»ºï¼šWebpack 5 å¿« 80-90%
- é‡å¯åæ„å»ºï¼šWebpack 5 å¿« 60-70%

### 3. Tree Shaking ä¼˜åŒ–

Webpack 5 åœ¨ Tree Shaking æ–¹é¢æœ‰äº†é‡å¤§æ”¹è¿›ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°åˆ†æå’Œæ¶ˆé™¤æ— ç”¨ä»£ç ã€‚

#### å…·ä½“æ”¹è¿›

**Webpack 4 çš„é™åˆ¶ï¼š**

```javascript
// æ— æ³•å¾ˆå¥½åœ°å¤„ç†åµŒå¥—çš„export
export { a, b } from "./module";
// å³ä½¿åªä½¿ç”¨aï¼Œbä¹Ÿå¯èƒ½è¢«æ‰“åŒ…è¿›æ¥
```

**Webpack 5 çš„ä¼˜åŒ–ï¼š**

```javascript
// æ›´ç²¾ç¡®çš„ä¾èµ–åˆ†æ
// package.jsonä¸­çš„sideEffectsé…ç½®æ›´æœ‰æ•ˆ
{
  "sideEffects": [
    "*.css",
    "*.scss",
    "./src/polyfills.js"
  ]
}

// webpack.config.js
module.exports = {
  optimization: {
    usedExports: true,
    providedExports: true,
    innerGraph: true, // æ–°å¢ï¼šå†…éƒ¨å›¾åˆ†æ
  },
};
```

##### **sideEffects çš„ä½œç”¨**

Webpack ä¼šåœ¨æ„å»ºæ—¶ï¼š

- åˆ é™¤æœªè¢«ä½¿ç”¨çš„å¯¼å‡º
- å¦‚æœå‘ç°å¯¼å…¥çš„æ–‡ä»¶è¢«æ ‡è®°ä¸ºæœ‰å‰¯ä½œç”¨ï¼Œå°±ä¿ç•™ä¸åˆ 
- å¦‚æœç¡®è®¤æ˜¯æ— å‰¯ä½œç”¨ï¼Œå°±æ”¾å¿ƒåˆ æ‰æœªå¼•ç”¨çš„éƒ¨åˆ†

**æ•ˆæœå¯¹æ¯”ï¼š**

```javascript
// ä»£ç ç¤ºä¾‹
import { debounce } from "lodash-es";

// Webpack 4: å¯èƒ½æ‰“åŒ…æ•´ä¸ªlodash-es
// Webpack 5: åªæ‰“åŒ…debounceç›¸å…³ä»£ç ï¼Œå‡å°‘30-50%ä½“ç§¯
```

### 4. Node.js Polyfill ç§»é™¤

Webpack 5 ä¸å†è‡ªåŠ¨ä¸º Node.js æ ¸å¿ƒæ¨¡å—æä¾› polyfillï¼Œè¿™æ˜¾è‘—å‡å°‘äº† bundle å¤§å°ã€‚

> Polyfill æ˜¯æŒ‡ï¼šå½“ä¸€ä¸ªç¯å¢ƒï¼ˆæ¯”å¦‚æµè§ˆå™¨ï¼‰ä¸æ”¯æŒæŸä¸ª API æˆ–åŠŸèƒ½æ—¶ï¼Œç”¨å·²æœ‰çš„ä»£ç æ¨¡æ‹Ÿå®ç°ï¼Œä½¿å®ƒâ€œçœ‹èµ·æ¥åƒæ”¯æŒâ€ã€‚

#### è¿ç§»å¯¹æ¯”

**Webpack 4ï¼ˆè‡ªåŠ¨ polyfillï¼‰ï¼š**

```javascript
// è‡ªåŠ¨åŒ…å«Node.js polyfill
import crypto from "crypto"; // è‡ªåŠ¨ä½¿ç”¨crypto-browserify
import path from "path"; // è‡ªåŠ¨ä½¿ç”¨path-browserify
```

**Webpack 5ï¼ˆéœ€è¦æ‰‹åŠ¨é…ç½®ï¼‰ï¼š**

```javascript
// webpack.config.js
module.exports = {
  resolve: {
    fallback: {
      crypto: require.resolve("crypto-browserify"),
      path: require.resolve("path-browserify"),
      fs: false, // ä¸æä¾›polyfill
    },
  },
};
```

**Bundle ä½“ç§¯å¯¹æ¯”ï¼š**

- ç®€å• React åº”ç”¨ï¼šå‡å°‘ 20-30KB
- å¤æ‚åº”ç”¨ï¼šå‡å°‘ 100KB+
- çº¯å‰ç«¯åº”ç”¨ï¼šå‡å°‘æ›´æ˜æ˜¾

| é¡¹ç›®                  | Webpack 4   | Webpack 5           |
| --------------------- | ----------- | ------------------- |
| Node.js æ¨¡å— polyfill | âœ… è‡ªåŠ¨å¯ç”¨ | âŒ é»˜è®¤ç§»é™¤         |
| ä½“ç§¯æ§åˆ¶              | âŒ ä¸ç²¾ç¡®   | âœ… æ›´å¯æ§           |
| å‡ºé”™æç¤º              | éšå¼è¡Œä¸º    | æŠ¥é”™+å»ºè®®ä½ æ‰‹åŠ¨é…ç½® |

### 5. èµ„æºæ¨¡å—ï¼ˆAsset Modulesï¼‰

Webpack 5 å†…ç½®äº†èµ„æºå¤„ç†èƒ½åŠ›ï¼Œä¸å†éœ€è¦ file-loaderã€url-loader ç­‰ã€‚

#### é…ç½®å¯¹æ¯”

**Webpack 4ï¼š**

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif)$/i,
        use: [
          {
            loader: "file-loader",
            options: {
              outputPath: "images",
            },
          },
        ],
      },
      {
        test: /\.svg$/,
        use: [
          {
            loader: "url-loader",
            options: {
              limit: 8192,
            },
          },
        ],
      },
    ],
  },
};
```

**Webpack 5ï¼š**

```javascript
module.exports = {
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif)$/i,
        type: "asset/resource", // æ›¿ä»£file-loader
        generator: {
          filename: "images/[hash][ext][query]",
        },
      },
      {
        test: /\.svg$/,
        type: "asset", // è‡ªåŠ¨é€‰æ‹©inlineæˆ–resource
        parser: {
          dataUrlCondition: {
            maxSize: 8 * 1024, // 8kb
          },
        },
      },
    ],
  },
};
```

## æ€§èƒ½å¯¹æ¯”åˆ†æ

### æ„å»ºé€Ÿåº¦å¯¹æ¯”

| é¡¹ç›®ç±»å‹ | Webpack 4 | Webpack 5ï¼ˆé¦–æ¬¡ï¼‰ | Webpack 5ï¼ˆç¼“å­˜ï¼‰ |
| -------- | --------- | ----------------- | ----------------- |
| å°å‹é¡¹ç›® | 10s       | 12s               | 2s                |
| ä¸­å‹é¡¹ç›® | 45s       | 50s               | 8s                |
| å¤§å‹é¡¹ç›® | 180s      | 200s              | 25s               |

### Bundle ä½“ç§¯å¯¹æ¯”

```javascript
// å®é™…é¡¹ç›®æµ‹è¯•ç»“æœ
const bundleSizeComparison = {
  "React App": {
    webpack4: "245KB",
    webpack5: "198KB", // å‡å°‘19%
  },
  "Vue App": {
    webpack4: "189KB",
    webpack5: "156KB", // å‡å°‘17%
  },
  "Complex SPA": {
    webpack4: "1.2MB",
    webpack5: "980KB", // å‡å°‘18%
  },
};
```

## å®é™…è¿ç§»

### é¡¹ç›®èƒŒæ™¯

- React + TypeScript é¡¹ç›®
- ä½¿ç”¨äº†å¤šä¸ªç¬¬ä¸‰æ–¹åº“
- æœ‰å¤æ‚çš„ä»£ç åˆ†å‰²éœ€æ±‚

### è¿ç§»æ­¥éª¤

#### 1. å‡çº§ä¾èµ–

```json
{
  "devDependencies": {
    "webpack": "^5.38.1",
    "webpack-cli": "^4.7.0",
    "webpack-dev-server": "^3.11.2"
  }
}
```

#### 2. é…ç½®è°ƒæ•´

```javascript
// webpack.config.js
const path = require("path");

module.exports = {
  // æ–°å¢cacheé…ç½®
  cache: {
    type: "filesystem",
    buildDependencies: {
      config: [__filename],
    },
  },

  // resolve fallbacké…ç½®
  resolve: {
    fallback: {
      path: require.resolve("path-browserify"),
      crypto: require.resolve("crypto-browserify"),
    },
  },

  // èµ„æºæ¨¡å—é…ç½®
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif|svg)$/i,
        type: "asset",
        parser: {
          dataUrlCondition: {
            maxSize: 8192,
          },
        },
      },
    ],
  },

  // ä¼˜åŒ–é…ç½®
  optimization: {
    splitChunks: {
      chunks: "all",
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: "vendors",
          chunks: "all",
        },
      },
    },
  },
};
```

#### 3. å¤„ç† breaking changes

```javascript
// ç§»é™¤ä¸å…¼å®¹çš„loader
// - ç§»é™¤ file-loader, url-loader, raw-loader
// - æ›´æ–° mini-css-extract-plugin
// - æ›´æ–° html-webpack-plugin

// package.jsonæ›´æ–°
{
  "devDependencies": {
    "mini-css-extract-plugin": "^1.6.0",
    "html-webpack-plugin": "^5.3.1"
  }
}
```

### è¿ç§»ç»“æœ

**æ€§èƒ½æå‡ï¼š**

- é¦–æ¬¡æ„å»ºï¼š+15%æ—¶é—´ï¼ˆå†™å…¥ç¼“å­˜ï¼‰
- äºŒæ¬¡æ„å»ºï¼š-85%æ—¶é—´
- Bundle ä½“ç§¯ï¼š-22%
- è¿è¡Œæ—¶æ€§èƒ½ï¼š+8%

**é‡åˆ°çš„é—®é¢˜ï¼š**

1. Node.js polyfill é—®é¢˜
2. éƒ¨åˆ† loader ä¸å…¼å®¹
3. ç¼“å­˜ç›®å½•é…ç½®

## é«˜çº§ç‰¹æ€§åº”ç”¨

### 1. Top Level Await

å¯ä»¥åœ¨æ¨¡å—çš„æœ€å¤–å±‚ç›´æ¥ä½¿ç”¨ awaitï¼Œä¸éœ€è¦æ”¾åœ¨ async å‡½æ•°é‡Œã€‚

```javascript
// Webpack 5æ”¯æŒé¡¶å±‚await
// webpack.config.js
module.exports = {
  experiments: {
    topLevelAwait: true,
  },
};

// åº”ç”¨ä»£ç 
const data = await fetch("/api/config").then((r) => r.json());
console.log(data);
```

### 2. æ›´å¥½çš„é•¿æœŸç¼“å­˜

```javascript
// Webpack 5çš„æ”¹è¿›
module.exports = {
  optimization: {
    moduleIds: "deterministic", // ç¡®å®šæ€§çš„module ID
    chunkIds: "deterministic", // ç¡®å®šæ€§çš„chunk ID
  },
  output: {
    filename: "[name].[contenthash].js",
    chunkFilename: "[name].[contenthash].chunk.js",
  },
};
```

### 3. Web Workers æ”¯æŒ

Web Worker æ˜¯æµè§ˆå™¨æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒå¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–è¿è¡Œ JavaScriptï¼Œä»è€Œé¿å… UI å¡é¡¿ã€è®¡ç®—é˜»å¡ã€‚ä¾‹å¦‚ï¼š

- å›¾ç‰‡å‹ç¼©
- å¯†é›†è®¡ç®—ï¼ˆåŠ å¯†ã€æ•°æ®å¤„ç†ï¼‰
- å®æ—¶é¢„å¤„ç†ï¼ˆå¦‚ markdown æ¸²æŸ“ã€è¯­æ³•æ£€æŸ¥ï¼‰
- WebAssembly åç«¯è®¡ç®—

```javascript
// Webpack 5åŸç”Ÿæ”¯æŒWeb Workers
// webpack.config.js
module.exports = {
  module: {
    rules: [
      {
        test: /\.worker\.js$/,
        type: "asset/resource",
        generator: {
          filename: "workers/[hash][ext][query]",
        },
      },
    ],
  },
};

// ä½¿ç”¨Worker
const worker = new Worker(new URL("./worker.js", import.meta.url));
```

## æœ€ä½³å®è·µå’Œå»ºè®®

### 1. æ¸è¿›å¼å‡çº§ç­–ç•¥

```javascript
// ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å‡çº§
{
  "webpack": "^5.0.0",
  "webpack-cli": "^4.0.0"
}

// ç¬¬äºŒé˜¶æ®µï¼šå¯ç”¨æ–°ç‰¹æ€§
module.exports = {
  cache: { type: 'filesystem' },
  experiments: {
    topLevelAwait: true,
  },
};

// ç¬¬ä¸‰é˜¶æ®µï¼šæ·±åº¦ä¼˜åŒ–
// å¯ç”¨æ¨¡å—è”é‚¦ã€èµ„æºæ¨¡å—ç­‰
```

### 2. æ€§èƒ½ç›‘æ§

```javascript
// æ„å»ºåˆ†æ
const BundleAnalyzerPlugin =
  require("webpack-bundle-analyzer").BundleAnalyzerPlugin;

module.exports = {
  plugins: [process.env.ANALYZE && new BundleAnalyzerPlugin()].filter(Boolean),
};

// ç¼“å­˜åˆ†æ
const SpeedMeasurePlugin = require("speed-measure-webpack-plugin");
const smp = new SpeedMeasurePlugin();

module.exports = smp.wrap({
  // webpacké…ç½®
});
```

### 3. å¼€å‘ä½“éªŒä¼˜åŒ–

```javascript
module.exports = {
  devServer: {
    hot: true,
    // Webpack 5æ”¹è¿›çš„HMR
  },
  stats: {
    errorDetails: true,
    // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
  },
};
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. Module not found é”™è¯¯

```javascript
// é”™è¯¯ï¼šCan't resolve 'crypto'
// è§£å†³æ–¹æ¡ˆ
module.exports = {
  resolve: {
    fallback: {
      crypto: require.resolve("crypto-browserify"),
      stream: require.resolve("stream-browserify"),
      buffer: require.resolve("buffer"),
    },
  },
  plugins: [
    new webpack.ProvidePlugin({
      Buffer: ["buffer", "Buffer"],
      process: "process/browser",
    }),
  ],
};
```

### 2. ç¼“å­˜é—®é¢˜

```javascript
// æ¸…é™¤ç¼“å­˜
rm -rf node_modules/.cache/webpack

// æˆ–è€…é…ç½®ç¼“å­˜
module.exports = {
  cache: {
    type: 'filesystem',
    version: '1.0', // ç‰ˆæœ¬æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
  },
};
```

### 3. æ€§èƒ½é—®é¢˜

```javascript
// ä¼˜åŒ–æ„å»ºæ€§èƒ½
module.exports = {
  optimization: {
    splitChunks: {
      chunks: "all",
      maxSize: 244 * 1024, // 244KB
    },
  },
  resolve: {
    symlinks: false, // å…³é—­ç¬¦å·é“¾æ¥è§£æ
  },
};
```
